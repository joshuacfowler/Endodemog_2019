---
title: "endodemog_figures"
author: "Joshua and Tom"
date: "5/24/2019"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Purpose: 
Visualizes output of endophyte effect on year variance from model outputs for Survival, Growth, Fertility, and Recruitment models. 

# source in R packages and load model outputs
```{r model outputs, include=FALSE}
source('endodemog_model_outputs.R')
```

```{r raw data processing, include=FALSE}
source('endodemog_data_processing.R')
```

```{r colorpalletes, include = FALSE}
#Looking at different color palettes
# Classic palette BuPu, with 4 colors
purps = brewer.pal(9, "Purples")
bupu = brewer.pal(9,"BuPu")
oran = brewer.pal(9, "Oranges")


brewer.pal(9, "Oranges")
orrd = brewer.pal(9, "OrRd")
# I can add more tones to this palette :
purps = colorRampPalette(purps)(11)
# pie(rep(1, length(purps)), col = purps , main="")
bupu = colorRampPalette(bupu)(11)
# pie(rep(1, length(bupu)), col = bupu , main="")
oran = colorRampPalette(oran)(11)
# pie(rep(1, length(oran)), col = oran , main="")
orrd = colorRampPalette(orrd)(11)
# pie(rep(1, length(orrd)), col = orrd , main="")

yearcolors <- c("#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99",
                "#e31a1c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a",
                "#ffff99")
colors2 <- c("#ff7f00","#6a3d9a") #"#ff7f00" = E-, "#e31a1c" = E+
```

Plots of variance posteriors
```{r variance histogram gg objects, include=FALSE}
# Variance posterior distributions by species
variance_histogram <- function(df){
  require(ggplot2)
  spp <- ggplot() + 
    geom_histogram(data = df, aes(`sigma_e[1]`), fill = "#ff7f00", alpha = .4, bins = 200) +
    geom_histogram(data = df, aes(`sigma_e[2]`), fill = "#6a3d9a", alpha = .4, bins = 200) +
    labs(x = expression(Ïƒ[year]), y = "Posterior density",
         title = deparse(substitute(df))) + theme_classic()
  return(spp)
}
# survival
AGPE_s <- variance_histogram(post_survAGPE)

ELRI_s <- variance_histogram(post_survELRI)

ELVI_s <- variance_histogram(post_survELVI)

FESU_s <- variance_histogram(post_survFESU)

LOAR_s <- variance_histogram(post_survLOAR)

POAL_s <- variance_histogram(post_survPOAL)

POSY_s <- variance_histogram(post_survPOSY)

# flowering
AGPE_f <- variance_histogram(post_flwAGPE)

ELRI_f <- variance_histogram(post_flwELRI)

ELVI_f <- variance_histogram(post_flwELVI)

FESU_f <- variance_histogram(post_flwFESU)

LOAR_f <- variance_histogram(post_flwLOAR)

POAL_f <- variance_histogram(post_flwPOAL)

POSY_f <- variance_histogram(post_flwPOSY)

# growth
AGPE_g <- variance_histogram(post_growAGPE)

ELRI_g <- variance_histogram(post_growELRI)

ELVI_g <- variance_histogram(post_growELVI)

FESU_g <- variance_histogram(post_growFESU)

LOAR_g <- variance_histogram(post_growLOAR)

POAL_g <- variance_histogram(post_growPOAL)

POSY_g <- variance_histogram(post_growPOSY)

# fertility

AGPE_fert <- variance_histogram(post_fertAGPE)

ELRI_fert <- variance_histogram(post_fertELRI)

ELVI_fert <- variance_histogram(post_fertELVI)

FESU_fert <- variance_histogram(post_fertFESU)

LOAR_fert <- variance_histogram(post_fertLOAR)

POAL_fert <- variance_histogram(post_fertPOAL)

POSY_fert <- variance_histogram(post_fertPOSY)


# combining the individual histograms together with grid.arrange and adding labels
survvar <- grid.arrange(AGPE_s, ELRI_s, ELVI_s, FESU_s, LOAR_s, POAL_s, POSY_s,  ncol= 1)
titlesurv <- annotate_figure(survvar, top = "Survival", left = "")
flwrvar <- grid.arrange(AGPE_f, ELRI_f, ELVI_f, FESU_f, LOAR_f, POAL_f, POSY_f, ncol= 1)
titleflw <- annotate_figure(flwrvar, top = "Flowering", left = "")
growvar <- grid.arrange(AGPE_g, ELRI_g, ELVI_g, FESU_g, LOAR_g, POAL_g, POSY_g,  ncol= 1)
titlegrow <- annotate_figure(growvar, top = "Growth", left = "")
fertvar <- grid.arrange(AGPE_fert, ELRI_fert, ELVI_fert, FESU_fert, LOAR_fert, POAL_fert, POSY_fert,  ncol= 1)
titlefert <- annotate_figure(fertvar, top = "Fertility", left = "")

var <- grid.arrange(titlesurv, titlegrow, titleflw, titlefert, ncol = 4)
titlevar <- annotate_figure(var, top = "Interannual Variance", left = "Posterior Density")
```

```{r variance histogram plots, echo=FALSE, fig.width = 9, fig.height = 12}
# plotting the combined figure of all the variance estimates by species and by vital rate
# These historgrams can be used indivually as panels for figures with model fits.
titlevar
```

Plots of model fits with data
```{r observed survival bins, include=FALSE}
# Function to bin the observed survival data according to endophyte status and size classes for plotting against the fitted model
surv_data_bins <- function(df_raw){
  require(tidyverse)
  surv_bin_minus <- df_raw %>% 
    select(surv_t1, logsize_t, year_t, endo) %>%
    mutate(endo = recode(endo, "0" = 0, "1" = 1, minus = 0, plus = 1)) %>% 
    filter(endo == 0) %>% 
    mutate(Year = as.factor(as.integer(as.factor(year_t)))) %>% 
    mutate(size_bin = cut_interval(logsize_t, n = 15)) %>% 
    group_by(size_bin, Year) %>% 
    summarise(mean_size = mean((logsize_t),na.rm=T),
            mean_surv = mean(surv_t1,na.rm=T),
            samplesize = n())
  
  surv_bin_plus <- df_raw %>% 
    select(surv_t1, logsize_t, year_t, endo) %>%
    mutate(endo = recode(endo, "0" = 0, "1" = 1, minus = 0, plus = 1)) %>% 
    filter(endo == 1) %>% 
    mutate(Year = as.factor(as.integer(as.factor(year_t)))) %>% 
    mutate(size_bin = cut_interval(logsize_t, n = 15)) %>% 
    group_by(size_bin, Year) %>% 
    summarise(mean_size = mean((logsize_t),na.rm=T),
              mean_surv = mean(surv_t1,na.rm=T),
              samplesize = n())

  surv_bin_byyear <- df_raw %>% 
    select(surv_t1, logsize_t, year_t, endo) %>%
    mutate(endo = recode(endo, "0" = 0, "1" = 1, minus = 0, plus = 1)) %>% 
    mutate(Year = as.factor(as.integer(as.factor(year_t)))) %>% 
    mutate(size_bin = cut_interval(logsize_t, n = 15)) %>% 
    group_by(size_bin, Year, endo) %>% 
    summarise(mean_size = mean((logsize_t),na.rm=T),
              mean_surv = mean(surv_t1,na.rm=T),
              samplesize = n())
  
  surv_bin_mean <- df_raw %>% 
    select(surv_t1, logsize_t, endo) %>%
    mutate(endo = recode(endo, "0" = "E-", "1" = "E+", minus = "E-", plus = "E+")) %>% 
    mutate(size_bin = cut_interval(logsize_t, n = 12)) %>% 
    group_by(size_bin, endo) %>% 
    summarise(mean_size = mean((logsize_t),na.rm=T),
              mean_surv = mean(surv_t1,na.rm=T),
              samplesize = n())
  
  surv_bins_list <- list(surv_bin_minus, surv_bin_plus, surv_bin_byyear, surv_bin_mean)
  names(surv_bins_list) <- c("surv_bins_minus", "surv_bins_plus", "surv_bin_byyear", "surv_bin_mean")
  return(surv_bins_list)
}

AGPEsurv_bins <- surv_data_bins(AGPE_surv_data)

ELRIsurv_bins <- surv_data_bins(ELRI_surv_data)

ELVIsurv_bins <- surv_data_bins(ELVI_surv_data)

FESUsurv_bins <- surv_data_bins(FESU_surv_data)

LOARsurv_bins <- surv_data_bins(LOAR_surv_data)

POALsurv_bins <- surv_data_bins(POAL_surv_data)

POSYsurv_bins <- surv_data_bins(POSY_surv_data)
```

```{r observed flowering bins, include=FALSE}
# Function to bin the observed flowering data according to endophyte status and size classes for plotting against the fitted model
flw_data_bins <- function(df_raw){
  require(tidyverse)
  flw_bin_minus <- df_raw %>% 
    select(flw_stat_t1, logsize_t, year_t, endo_01) %>%
    filter(endo_01 == 0) %>% 
    mutate(Year = as.factor(as.integer(as.factor(year_t)))) %>% 
    mutate(size_bin = cut_interval(logsize_t, n = 15)) %>% 
    group_by(size_bin, Year) %>% 
    summarise(mean_size = mean((logsize_t),na.rm=T),
              mean_flw = mean(flw_stat_t1,na.rm=T),
              samplesize = n())

  flw_bin_plus <- df_raw %>% 
    select(flw_stat_t1, logsize_t, year_t, endo_01) %>%
    filter(endo_01 == 1) %>% 
    mutate(Year = as.factor(as.integer(as.factor(year_t)))) %>% 
    mutate(size_bin = cut_interval(logsize_t, n = 15)) %>% 
    group_by(size_bin, Year) %>% 
    summarise(mean_size = mean((logsize_t),na.rm=T),
              mean_flw = mean(flw_stat_t1,na.rm=T),
              samplesize = n())
  
  flw_bin_byyear <- df_raw %>% 
    select(flw_stat_t1, logsize_t, year_t, endo_01) %>%
    mutate(Year = as.factor(as.integer(as.factor(year_t)))) %>% 
    mutate(size_bin = cut_interval(logsize_t, n = 15)) %>% 
    group_by(size_bin, Year, endo_01) %>% 
    summarise(mean_size = mean((logsize_t),na.rm=T),
              mean_flw = mean(flw_stat_t1,na.rm=T),
              samplesize = n())


  flw_binmean <- df_raw %>% 
    select(flw_stat_t1, logsize_t, endo_01) %>%
    mutate(endo_01 = recode(endo_01, "0" = "E-", "1" = "E+", minus = 'E-', plus = 'E+')) %>% 
    mutate(size_bin = cut_interval(logsize_t, n = 12)) %>% 
    group_by(size_bin, endo_01) %>% 
    summarise(mean_size = mean((logsize_t),na.rm=T),
              mean_flw = mean(flw_stat_t1,na.rm=T),
              samplesize = n())
  flw_bins_list <- list(flw_bin_minus, flw_bin_plus, flw_bin_byyear, flw_bin_mean)
  return(flw_bins_list)
}

AGPEflw_bins <- flw_data_bins(AGPE_flw_data)

ELRIflw_bins <- flw_data_bins(ELRI_flw_data)

ELVIflw_bins <- flw_data_bins(ELVI_flw_data)

FESUflw_bins <- flw_data_bins(FESU_flw_data)

LOARflw_bins <- flw_data_bins(LOAR_flw_data)

POALflw_bins <- flw_data_bins(POAL_flw_data)

POSYflw_bins <- flw_data_bins(POSY_flw_data)
```

```{r observed growth bins, include=FALSE}
# Function to bin the observed growth data according to endophyte status and size classes for plotting against the fitted model
grow_data_bins <- function(df_raw){
  require(tidyverse)
  grow_bin_minus<- df_raw %>% 
    select(size_t1, logsize_t, year_t, endo_01) %>%
    filter(endo_01 == 0) %>% 
    mutate(Year = as.factor(as.integer(as.factor(year_t)))) %>% 
    mutate(size_bin = cut_interval(logsize_t, n = 15)) %>% 
    group_by(size_bin, Year) %>% 
    summarise(mean_size = mean((logsize_t),na.rm=T),
              mean_grow = mean(size_t1,na.rm=T),
              samplesize = n())
  
  grow_bin_plus <- df_raw %>% 
    select(size_t1, logsize_t, year_t, endo_01) %>%
    filter(endo_01 == 1) %>% 
    mutate(Year = as.factor(as.integer(as.factor(year_t)))) %>% 
    mutate(size_bin = cut_interval(logsize_t, n = 15)) %>% 
    group_by(size_bin, Year) %>% 
    summarise(mean_size = mean((logsize_t),na.rm=T),
              mean_grow = mean(size_t1,na.rm=T),
              samplesize = n())
  
  grow_bin_byyear <- df_raw %>% 
    select(size_t1, logsize_t, year_t, endo_01) %>%
    mutate(Year = as.factor(as.integer(as.factor(year_t)))) %>% 
    mutate(size_bin = cut_interval(logsize_t, n = 15)) %>% 
    group_by(size_bin, Year, endo_01) %>% 
    summarise(mean_size = mean((logsize_t),na.rm=T),
              mean_grow = mean(size_t1,na.rm=T),
              samplesize = n())
  
  grow_binmean <- df_raw %>% 
    select(size_t1, logsize_t, endo_01) %>%
    mutate(endo_01 = as.character(endo_01)) %>% 
    mutate(size_bin = cut_interval(logsize_t, n = 12)) %>% 
    group_by(size_bin, endo_01) %>% 
    summarise(mean_size = mean((logsize_t),na.rm=T),
              mean_grow = mean(size_t1,na.rm=T),
              samplesize = n())

  grow_bins_list <- list(grow_bin_minus, grow_bin_plus, grow_bin_byyear, grow_binmean)
  return(grow_bins_list)
}

AGPEgrow_bins <- grow_data_bins(AGPE_grow_data)

ELRIgrow_bins <- grow_data_bins(ELRI_grow_data)

ELVIgrow_bins <- grow_data_bins(ELVI_grow_data)

FESUgrow_bins <- grow_data_bins(FESU_grow_data)

LOARgrow_bins <- grow_data_bins(LOAR_grow_data)

POALgrow_bins <- grow_data_bins(POAL_grow_data)

POSYgrow_bins <- grow_data_bins(POSY_grow_data)
```


```{r observed fertility bins, include=FALSE}
# Function to bin the observed growth data according to endophyte status and size classes for plotting against the fitted model
fert_data_bins <- function(df_raw){
  require(tidyverse)
  fert_bin_minus<- df_raw %>% 
    select(flw_t, logsize_t, year_t, endo_01) %>%
    filter(endo_01 == 0) %>% 
    mutate(Year = as.factor(as.integer(as.factor(year_t)))) %>% 
    mutate(size_bin = cut_interval(logsize_t, n = 15)) %>% 
    group_by(size_bin, Year) %>% 
    summarise(mean_size = mean((logsize_t),na.rm=T),
              mean_fert = mean(flw_t,na.rm=T),
              samplesize = n())
  
  fert_bin_plus <- df_raw %>% 
    select(flw_t, logsize_t, year_t, endo_01) %>%
    filter(endo_01 == 1) %>% 
    mutate(Year = as.factor(as.integer(as.factor(year_t)))) %>% 
    mutate(size_bin = cut_interval(logsize_t, n = 15)) %>% 
    group_by(size_bin, Year) %>% 
    summarise(mean_size = mean((logsize_t),na.rm=T),
              mean_fert = mean(flw_t,na.rm=T),
              samplesize = n())
  
  fert_bin_byyear <- df_raw %>% 
    select(flw_t, logsize_t, year_t, endo_01) %>%
    mutate(Year = as.factor(as.integer(as.factor(year_t)))) %>% 
    mutate(size_bin = cut_interval(logsize_t, n = 15)) %>% 
    group_by(size_bin, Year, endo_01) %>% 
    summarise(mean_size = mean((logsize_t),na.rm=T),
              mean_fert = mean(flw_t,na.rm=T),
              samplesize = n())
  
  fert_binmean <- df_raw %>% 
    select(flw_t, logsize_t, endo_01) %>%
    mutate(endo_01 = as.character(endo_01)) %>% 
    mutate(size_bin = cut_interval(logsize_t, n = 12)) %>% 
    group_by(size_bin, endo_01) %>% 
    summarise(mean_size = mean((logsize_t),na.rm=T),
              mean_fert = mean(flw_t,na.rm=T),
              samplesize = n())

  fert_bins_list <- list(fert_bin_minus, fert_bin_plus, fert_bin_byyear, fert_binmean)
  return(fert_bins_list)
}

AGPEfert_bins <- fert_data_bins(AGPE_fert_data)

ELRIfert_bins <- fert_data_bins(ELRI_fert_data)

ELVIfert_bins <- fert_data_bins(ELVI_fert_data)

FESUfert_bins <- fert_data_bins(FESU_fert_data)

LOARfert_bins <- fert_data_bins(LOAR_fert_data)

POALfert_bins <- fert_data_bins(POAL_fert_data)

POSYfert_bins <- fert_data_bins(POSY_fert_data)
```



```{r survival fits, include=FALSE}
# function to generate the mean, and year and plot specific survival model fits and store for plotting
surv_fits <- function(df_raw, df_samples){
  require(tidyverse)

  nvalues <- length(df_raw$logsize_t)
  xdummy <- seq(min(df_raw$logsize_t), max(df_raw$logsize_t), length.out = nvalues)

  #endophyte negative fits  
  ydummy_eminus <- as.vector(invlogit(mean(df_samples$'beta[1]') + mean(df_samples$'beta[2]')*xdummy + mean(df_samples$'beta[3]')*0 + mean(df_samples$'beta[4]')*mean(df_raw$origin_01) + mean(df_samples$'beta[5]')*xdummy*0))
  ydummy_eminus_y1 <- as.vector(invlogit(mean(df_samples$'beta[1]') + mean(df_samples$'beta[2]')*xdummy + mean(df_samples$'beta[3]')*0 + mean(df_samples$'beta[4]')*mean(df_raw$origin_01) + mean(df_samples$'beta[5]')*xdummy*0 + mean(df_samples$'tau_year[1,1]')))
  ydummy_eminus_y2 <- as.vector(invlogit(mean(df_samples$'beta[1]') + mean(df_samples$'beta[2]')*xdummy + mean(df_samples$'beta[3]')*0 + mean(df_samples$'beta[4]')*mean(df_raw$origin_01) + mean(df_samples$'beta[5]')*xdummy*0 + mean(df_samples$'tau_year[1,2]')))
  ydummy_eminus_y3 <- as.vector(invlogit(mean(df_samples$'beta[1]') + mean(df_samples$'beta[2]')*xdummy + + mean(df_samples$'beta[3]')*0  + mean(df_samples$'beta[4]')*mean(df_raw$origin_01) + mean(df_samples$'beta[5]')*xdummy*0 + mean(df_samples$'tau_year[1,3]')))
  ydummy_eminus_y4 <- as.vector(invlogit(mean(df_samples$'beta[1]') + mean(df_samples$'beta[2]')*xdummy + mean(df_samples$'beta[3]')*0 + mean(df_samples$'beta[4]')*mean(df_raw$origin_01) + mean(df_samples$'beta[5]')*xdummy*0 + mean(df_samples$'tau_year[1,4]'))) 
  ydummy_eminus_y5 <- as.vector(invlogit(mean(df_samples$'beta[1]') + mean(df_samples$'beta[2]')*xdummy + mean(df_samples$'beta[3]')*0 + mean(df_samples$'beta[4]')*mean(df_raw$origin_01) + mean(df_samples$'beta[5]')*xdummy*0 + mean(df_samples$'tau_year[1,5]')))
  ydummy_eminus_y6 <- as.vector(invlogit(mean(df_samples$'beta[1]') + mean(df_samples$'beta[2]')*xdummy + mean(df_samples$'beta[3]')*0 + mean(df_samples$'beta[4]')*mean(df_raw$origin_01) + mean(df_samples$'beta[5]')*xdummy*0 + mean(df_samples$'tau_year[1,6]')))
  ydummy_eminus_y7 <- as.vector(invlogit(mean(df_samples$'beta[1]') + mean(df_samples$'beta[2]')*xdummy + mean(df_samples$'beta[3]')*0 + mean(df_samples$'beta[4]')*mean(df_raw$origin_01) + mean(df_samples$'beta[5]')*xdummy*0 + mean(df_samples$'tau_year[1,7]')))
  ydummy_eminus_y8 <- as.vector(invlogit(mean(df_samples$'beta[1]') + mean(df_samples$'beta[2]')*xdummy + mean(df_samples$'beta[3]')*0 + mean(df_samples$'beta[4]')*mean(df_raw$origin_01) + mean(df_samples$'beta[5]')*xdummy*0 + mean(df_samples$'tau_year[1,8]')))
  ydummy_eminus_y9 <- as.vector(invlogit(mean(df_samples$'beta[1]') + mean(df_samples$'beta[2]')*xdummy + mean(df_samples$'beta[3]')*0 + mean(df_samples$'beta[4]')*mean(df_raw$origin_01) + mean(df_samples$'beta[5]')*xdummy*0 + mean(df_samples$'tau_year[1,9]')))
  ydummy_eminus_y10 <- as.vector(invlogit(mean(df_samples$'beta[1]') + mean(df_samples$'beta[2]')*xdummy + mean(df_samples$'beta[3]')*0 + mean(df_samples$'beta[4]')*mean(df_raw$origin_01) + mean(df_samples$'beta[5]')*xdummy*0 + mean(df_samples$'tau_year[1,10]')))
  ydummy_eminus_y11 <- as.vector(invlogit(mean(df_samples$'beta[1]') + mean(df_samples$'beta[2]')*xdummy + mean(df_samples$'beta[3]')*0 + mean(df_samples$'beta[4]')*mean(df_raw$origin_01) + mean(df_samples$'beta[5]')*xdummy*0 + mean(df_samples$'tau_year[1,11]')))
  
  # endophyte positive fits
  ydummy_eplus <- as.vector(invlogit(mean(df_samples$'beta[1]') + mean(df_samples$'beta[2]')*xdummy + mean(df_samples$'beta[3]')*1 + mean(df_samples$'beta[4]')*mean(df_raw$origin_01) + mean(df_samples$'beta[5]')*xdummy*1))
  ydummy_eplus_y1 <- as.vector(invlogit(mean(df_samples$'beta[1]') + mean(df_samples$'beta[2]')*xdummy + mean(df_samples$'beta[3]')*1 + mean(df_samples$'beta[4]')*mean(df_raw$origin_01) + mean(df_samples$'beta[5]')*xdummy*1 + mean(df_samples$'tau_year[2,1]')))
  ydummy_eplus_y2 <- as.vector(invlogit(mean(df_samples$'beta[1]') + mean(df_samples$'beta[2]')*xdummy + mean(df_samples$'beta[3]')*1 + mean(df_samples$'beta[4]')*mean(df_raw$origin_01) + mean(df_samples$'beta[5]')*xdummy*1 + mean(df_samples$'tau_year[2,2]')))
  ydummy_eplus_y3 <- as.vector(invlogit(mean(df_samples$'beta[1]') + mean(df_samples$'beta[2]')*xdummy + + mean(df_samples$'beta[3]')*1  + mean(df_samples$'beta[4]')*mean(df_raw$origin_01) + mean(df_samples$'beta[5]')*xdummy*1 + mean(df_samples$'tau_year[2,3]')))
  ydummy_eplus_y4 <- as.vector(invlogit(mean(df_samples$'beta[1]') + mean(df_samples$'beta[2]')*xdummy + mean(df_samples$'beta[3]')*1 + mean(df_samples$'beta[4]')*mean(df_raw$origin_01) + mean(df_samples$'beta[5]')*xdummy*1 + mean(df_samples$'tau_year[2,4]'))) 
  ydummy_eplus_y5 <- as.vector(invlogit(mean(df_samples$'beta[1]') + mean(df_samples$'beta[2]')*xdummy + mean(df_samples$'beta[3]')*1 + mean(df_samples$'beta[4]')*mean(df_raw$origin_01) + mean(df_samples$'beta[5]')*xdummy*1 + mean(df_samples$'tau_year[2,5]')))
  ydummy_eplus_y6 <- as.vector(invlogit(mean(df_samples$'beta[1]') + mean(df_samples$'beta[2]')*xdummy + mean(df_samples$'beta[3]')*1 + mean(df_samples$'beta[4]')*mean(df_raw$origin_01) + mean(df_samples$'beta[5]')*xdummy*1 + mean(df_samples$'tau_year[2,6]')))
  ydummy_eplus_y7 <- as.vector(invlogit(mean(df_samples$'beta[1]') + mean(df_samples$'beta[2]')*xdummy + mean(df_samples$'beta[3]')*1 + mean(df_samples$'beta[4]')*mean(df_raw$origin_01) + mean(df_samples$'beta[5]')*xdummy*1 + mean(df_samples$'tau_year[2,7]')))
  ydummy_eplus_y8 <- as.vector(invlogit(mean(df_samples$'beta[1]') + mean(df_samples$'beta[2]')*xdummy + mean(df_samples$'beta[3]')*1 + mean(df_samples$'beta[4]')*mean(df_raw$origin_01) + mean(df_samples$'beta[5]')*xdummy*1 + mean(df_samples$'tau_year[2,8]')))
  ydummy_eplus_y9 <- as.vector(invlogit(mean(df_samples$'beta[1]') + mean(df_samples$'beta[2]')*xdummy + mean(df_samples$'beta[3]')*1 + mean(df_samples$'beta[4]')*mean(df_raw$origin_01) + mean(df_samples$'beta[5]')*xdummy*1 + mean(df_samples$'tau_year[2,9]')))
  ydummy_eplus_y10 <- as.vector(invlogit(mean(df_samples$'beta[1]') + mean(df_samples$'beta[2]')*xdummy + mean(df_samples$'beta[3]')*1 + mean(df_samples$'beta[4]')*mean(df_raw$origin_01) + mean(df_samples$'beta[5]')*xdummy*1 + mean(df_samples$'tau_year[2,10]')))
  ydummy_eplus_y11 <- as.vector(invlogit(mean(df_samples$'beta[1]') + mean(df_samples$'beta[2]')*xdummy + mean(df_samples$'beta[3]')*1 + mean(df_samples$'beta[4]')*mean(df_raw$origin_01) + mean(df_samples$'beta[5]')*xdummy*1 + mean(df_samples$'tau_year[2,11]')))
  
  eminus <- list(ydummy_eminus, ydummy_eminus_y1, ydummy_eminus_y2, ydummy_eminus_y3, ydummy_eminus_y4, ydummy_eminus_y5, ydummy_eminus_y6, ydummy_eminus_y7, ydummy_eminus_y8, ydummy_eminus_y9, ydummy_eminus_y10, ydummy_eminus_y11)
  names(eminus) <- c("mean", "y1", "y2", "y3", "y4", "y5", "y6", "y7", "y8", "y9", "y10", "y11")
  
  eplus <- list(ydummy_eplus, ydummy_eplus_y1, ydummy_eplus_y2, ydummy_eplus_y3, ydummy_eplus_y4, ydummy_eplus_y5, ydummy_eplus_y6, ydummy_eplus_y7, ydummy_eplus_y8, ydummy_eplus_y9, ydummy_eplus_y10, ydummy_eplus_y11)
  names(eplus) <- c("mean", "y1", "y2", "y3", "y4", "y5", "y6", "y7", "y8", "y9", "y10", "y11")  
  
  surv_fits_list <- list(eminus, eplus, xdummy)
  names(surv_fits_list) <- c("eminus", "eplus", "xdummy")
  return(surv_fits_list)
}

AGPEsurv_fits <- surv_fits(AGPE_surv_data, post_survAGPE)

ELRIsurv_fits <- surv_fits(ELRI_surv_data, post_survELRI)

ELVIsurv_fits <- surv_fits(ELVI_surv_data, post_survELVI)

FESUsurv_fits <- surv_fits(FESU_surv_data, post_survFESU)

LOARsurv_fits <- surv_fits(LOAR_surv_data, post_survLOAR)

POALsurv_fits <- surv_fits(POAL_surv_data, post_survPOAL)

POSYsurv_fits <- surv_fits(POSY_surv_data, post_survPOAL)

```

```{r flowering fits, include=FALSE}
# function to generate the mean, and year and plot specific flowering model fits and store for plotting
flw_fits <- function(df_raw, df_samples){
  require(tidyverse)

  nvalues <- length(df_raw$logsize_t)
  xdummy <- seq(min(df_raw$logsize_t), max(df_raw$logsize_t), length.out = nvalues)


}
```

```{r growth fits, include=FALSE}
# function to generate the mean, and year and plot specific growth model fits and store for plotting
grow_fits <- function(df_raw, df_samples){
  require(tidyverse)

  nvalues <- length(df_raw$logsize_t)
  xdummy <- seq(min(df_raw$logsize_t), max(df_raw$logsize_t), length.out = nvalues)


}
```

```{r fertility fits, include=FALSE}
# function to generate the mean, and year and plot specific fertility model fits and store for plotting
fert_fits <- function(df_raw, df_samples){
  require(tidyverse)
  
  nvalues <- length(df_raw$logsize_t)
  xdummy <- seq(min(df_raw$logsize_t), max(df_raw$logsize_t), length.out = nvalues)


}
```


```{r survival raw and fits ggobjects, include = FALSE}
# Putting together the raw, binned data and the fitted models so that they can be visualized together.
surv_minus_byyear <- function(fits, bins, title){
  require(ggplot2)
  fits_df <- as.data.frame(fits)
  fits_df <- melt(fits_df, id = "xdummy",
                      measure.vars = c("eminus.y1","eminus.y2", 
                                       "eminus.y3", "eminus.y4", 
                                       "eminus.y5", "eminus.y6", 
                                       "eminus.y7", "eminus.y8", 
                                       "eminus.y9", "eminus.y10",
                                       "eminus.y11")) %>% 
  mutate(Year = recode(variable, "eminus.y1" = '1',"eminus.y2" = "2", 
                       "eminus.y3" = "3", "eminus.y4" = "4", 
                       "eminus.y5" = "5", "eminus.y6" = "6", 
                       "eminus.y7" = "7", "eminus.y8" = "8", 
                       "eminus.y9" = "9", "eminus.y10" = "10",
                       "eminus.y11" = "11")) 
  bins_df <- as.data.frame(bins[["surv_bins_minus"]])
  Eminusbyyear <- ggplot(data = fits_df) +
  geom_line(aes(x = xdummy, y = value, color = Year),  lwd = .8) +
  geom_point(data = bins_df, aes(x = mean_size, y = mean_surv, color = Year, lwd = samplesize)) +  
  labs(title = title, subtitle = "E-", xlab = "log(size_t)", ylab = "Prob. of Survival") +
  scale_color_manual(values = yearcolors) + guides(lwd = "none") + theme_classic()
return(Eminusbyyear)  
}
surv_plus_byyear <- function(fits, bins, title){
  require(ggplot2)
  fits_df <- as.data.frame(fits)
    fits_df <- melt(fits_df, id = "xdummy",
                      measure.vars = c("eplus.y1","eplus.y2", 
                                       "eplus.y3", "eplus.y4", 
                                       "eplus.y5", "eplus.y6", 
                                       "eplus.y7", "eplus.y8", 
                                       "eplus.y9", "eplus.y10",
                                       "eplus.y11")) %>% 
  mutate(Year = recode(variable, "eplus.y1" = '1',"eplus.y2" = "2", 
                       "eplus.y3" = "3", "eplus.y4" = "4", 
                       "eplus.y5" = "5", "eplus.y6" = "6", 
                       "eplus.y7" = "7", "eplus.y8" = "8", 
                       "eplus.y9" = "9", "eplus.y10" = "10",
                       "eplus.y11" = "11")) 
  bins_df <- as.data.frame(bins[["surv_bins_plus"]])
  Eplusbyyear <- ggplot(data = fits_df) +
  geom_line(aes(x = xdummy, y = value, color = Year), lwd = .8) +
  geom_point(data = bins_df, aes(x = mean_size, y = mean_surv, color = Year, lwd = samplesize)) +  
  labs(title = title, subtitle = "E+", xlab = "log(size_t)", ylab = "Prob. of Survival") +
  scale_color_manual(values = yearcolors) + guides(lwd = "none") +theme_classic()
return(Eplusbyyear)  
}
surv_mean <- function(fits, bins, title){
fits_df <- as.data.frame(fits)
bins_df <- as.data.frame(bins[["surv_bin_mean"]])
survmean <- ggplot(data = fits_df) +
  geom_line(aes(x = xdummy, y = eplus.mean), color = "#6a3d9a")+
  geom_line(aes(x = xdummy, y = eminus.mean), color = "#ff7f00") +
  geom_point(data = bins_df, aes(x = mean_size, y = mean_surv, color = endo, lwd = samplesize)) +
  labs(title = title, subtitle = "Mean Survival Probability", xlab = "log(size_t)", ylab = "Prob. of Survival") +
  scale_color_manual(values = colors2) + theme_classic() + guides(lwd = "none")
return(survmean)
}

AGPEsurv_minus_byyear <- surv_minus_byyear(AGPEsurv_fits, AGPEsurv_bins, title = "AGPE")
AGPEsurv_plus_byyear <- surv_plus_byyear(AGPEsurv_fits, AGPEsurv_bins, title = "AGPE")
AGPEsurv_mean <- surv_mean(AGPEsurv_fits, AGPEsurv_bins, title = "AGPE")

ELRIsurv_minus_byyear <- surv_minus_byyear(ELRIsurv_fits, ELRIsurv_bins, title = "ELRI")
ELRIsurv_plus_byyear <- surv_plus_byyear(ELRIsurv_fits, ELRIsurv_bins, title = "ELRI")
ELRIsurv_mean <- surv_mean(ELRIsurv_fits, ELRIsurv_bins, title = "ELRI")

ELVIsurv_minus_byyear <- surv_minus_byyear(ELVIsurv_fits, ELVIsurv_bins, title = "ELVI")
ELVIsurv_plus_byyear <- surv_plus_byyear(ELVIsurv_fits, ELVIsurv_bins, title = "ELVI")
ELVIsurv_mean <- surv_mean(ELVIsurv_fits, ELVIsurv_bins, title = "ELVI")

FESUsurv_minus_byyear <- surv_minus_byyear(FESUsurv_fits, FESUsurv_bins, title = "FESU")
FESUsurv_plus_byyear <- surv_plus_byyear(FESUsurv_fits, FESUsurv_bins, title = "FESU")
FESUsurv_mean <- surv_mean(FESUsurv_fits, FESUsurv_bins, title = "FESU")

LOARsurv_minus_byyear <- surv_minus_byyear(LOARsurv_fits, LOARsurv_bins, title = "LOAR")
LOARsurv_plus_byyear <- surv_plus_byyear(LOARsurv_fits, LOARsurv_bins, title = "LOAR")
LOARsurv_mean <- surv_mean(LOARsurv_fits, LOARsurv_bins, title = "LOAR")

POALsurv_minus_byyear <- surv_minus_byyear(POALsurv_fits, POALsurv_bins, title = "POAL")
POALsurv_plus_byyear <- surv_plus_byyear(POALsurv_fits, POALsurv_bins, title = "POAL")
POALsurv_mean <- surv_mean(POALsurv_fits, POALsurv_bins, title = "POAL")

POSYsurv_minus_byyear <- surv_minus_byyear(POSYsurv_fits, POSYsurv_bins, title = "POSY")
POSYsurv_plus_byyear <- surv_plus_byyear(POSYsurv_fits, POSYsurv_bins, title = "POSY")
POSYsurv_mean <- surv_mean(POSYsurv_fits, POSYsurv_bins, title = "POSY")

```


